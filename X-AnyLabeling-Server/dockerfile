# PyTorch GPU base with CUDA 12.8 + cuDNN 9
FROM pytorch/pytorch:2.9.1-cuda12.8-cudnn9-runtime

ENV PYTHONDONTWRITEBYTECODE=1 \
        PYTHONUNBUFFERED=1 \
        PIP_NO_CACHE_DIR=1

WORKDIR /app

ARG GIT_REPO_URL=https://github.com/CVHub520/X-AnyLabeling-Server.git
ARG GIT_REF=main

RUN apt-get update && apt-get install -y --no-install-recommends \
        git \
        ffmpeg \
        libgl1 \
        libglib2.0-0 \
        && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 --branch "$GIT_REF" "$GIT_REPO_URL" /app

RUN pip install --upgrade pip uv
RUN uv pip install --system --no-cache .[all]

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]